{% block head %}
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
    }

    body {
        display: flex;
        align-items: flex-start;
        justify-content: center;
        flex-direction: column;
    }

    #control-panel {
        margin-bottom: 20px;
    }

    #svg-container {
        width: 100%;
        height: 600px;
        border: 1px solid #ccc;
        overflow: auto;
    }

    svg {
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div id="control-panel">
    <label for="plan-selector">Select Plan Type:</label>
    <select id="plan-selector">
        <option value="logical">Logical Plan</option>
        <option value="pipeline">Pipeline Plan</option>
    </select>
</div>

<div id="svg-container">
    <svg id="svg"></svg>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import * as d3 from "https://cdn.skypack.dev/d3@7.8.4";
    import * as d3dag from "https://cdn.skypack.dev/d3-dag@1.1.0";

    const logicalQueryPlan = {{ benchmark.logical_query_plan | default('[]') | tojson }};
    const pipelineQueryPlan = {{ benchmark.pipeline_query_plan | default('[]') | tojson }};

    console.log(pipelineQueryPlan);

    /**
     * Adds zoom and pan functionality exclusively for the graph SVG.
     * @param {Object} svg - The D3 selection of the SVG element.
     * @param {Object} zoomableGroup - The <g> group that contains the graph elements.
     */
    function setupZoom(svg, zoomableGroup) {
        const zoomBehavior = d3.zoom()
            .scaleExtent([0.1, 2]) // Set zoom limits to 50% to 500% scaling
            .on("zoom", (event) => {
                // Apply the zoom transformation to the zoomable group
                zoomableGroup.attr("transform", event.transform);
            });

        // Activate zoom only when interacting with the SVG
        svg.on("mouseover", () => {
            svg.call(zoomBehavior); // Enable zoom behavior
        });

        svg.on("mouseleave", () => {
            svg.on(".zoom", null); // Disable zoom behavior
        });
    }

    /**
     * Draws the graph visualization and sets up the zoom behavior.
     * @param {string} planType - Type of the plan (logical or pipeline).
     * @param {Array} planData - The input data to render the graph.
     */
    function drawGraph(planType, planData) {
        if (!Array.isArray(planData) || planData.length === 0) {
            console.error(`No data found for ${planType}!`);
            return;
        }

        // Clear the SVG before rendering
        const svg = d3.select("#svg");
        svg.selectAll("*").remove();

        // Create a zoomable group
        const zoomableGroup = svg.append("g").attr("class", "zoomable-group");

        // Setup zoom functionality exclusive to the SVG
        setupZoom(svg, zoomableGroup);

        // Existing graph rendering logic
        const nodes = planType === "logical"
            ? planData.map(node => ({
                id: String(node.id),
                label: node.label,
                parentIds: (node.inputs || []).map(input => String(input)),
                type: node.node_type || "Unknown"
            }))
            : planData.flatMap(pipeline => pipeline.operators.map(op => ({
                id: String(op.id),
                label: `${op.label} (Pipeline ${pipeline.pipelineId})`,
                parentIds: (op.inputs || []).map(input => String(input)),
                type: "Operator",
                pipeline_id: pipeline.pipelineId
            })));

        const stratify = d3dag.graphStratify()
            .id(d => d.id)
            .parentIds(d => d.parentIds);

        const graph = stratify(nodes);

        const layout = d3dag.sugiyama()
            .layering(d3dag.layeringTopological())
            .nodeSize([120, 60])
            .coord(d3dag.coordTopological());
        layout(graph);

        // Draw edges
        const line = d3.line().curve(d3.curveMonotoneY);
        zoomableGroup.selectAll("path")
            .data(graph.links())
            .join("path")
            .attr("d", d => line(d.points))
            .attr("fill", "none")
            .attr("stroke", "#aaa")
            .attr("stroke-width", 2);

        // Draw nodes with rectangular shapes
        zoomableGroup.selectAll("g")
            .data(graph.nodes())
            .join("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.x},${d.y})`)
            .each(function (d) {
                const g = d3.select(this);

                const labelText = d.data.label || "Unnamed";
                const text = g.append("text")
                    .text(d.data.label || "Unnamed")
                    .attr("text-anchor", "middle")
                    .attr("y", 10)
                    .style("fill", "black")
                    .style("font-size", "12px");

                const textWidth = text.node().getBBox().width;
                const boxPadding = 10;

                g.insert("rect", "text")
                    .attr("x", -(textWidth / 2) - boxPadding / 2)
                    .attr("y", -15)
                    .attr("width", textWidth + boxPadding)
                    .attr("height", 30)
                    .attr("fill", getNodeColor(d.data.type))
                    .attr("stroke", "black")
                    .attr("rx", 5)
                    .attr("ry", 5);

                g.append("text")
                    .text(d.data.type || "Unknown")
                    .attr("text-anchor", "middle")
                    .attr("y", -5)
                    .style("fill", "black")
                    .style("font-size", "10px")
                    .style("font-weight", "bold");

                if (labelText.length > 25) {
                    g.append("title").text(labelText);
                }
            });
    }

    /**
     * Returns a color based on the type of the node.
     * @param {string} type - The type of the node.
     * @returns {string} The color for the node.
     */
    function getNodeColor(type) {
        const colors = {
            "Source": "#99ccff",
            "Sink": "#ff9999",
            "Filter": "#c0c0c0",
            "Selection": "#4682b4",
            "Map": "#98fb98",
            "Projection": "#dda0dd",
            "WindowedAggregation": "#ffa500",
            "EventTimeWatermarkAssigner": "#ba55d3",
            "Operator": "#d8bfd8",
            "Unknown": "#cccccc"
        };
        return colors[type] || "#cccccc";
    }

    // Initialize the visualization
    document.addEventListener("DOMContentLoaded", () => {
        const selector = document.getElementById("plan-selector");

        // Load the default Logical Plan on startup
        drawGraph("logical", logicalQueryPlan);

        // Load the selected plan based on user input
        selector.addEventListener("change", (event) => {
            const selectedPlan = event.target.value;
            if (selectedPlan === "logical") {
                drawGraph("logical", logicalQueryPlan);
            } else if (selectedPlan === "pipeline") {
                drawGraph("pipeline", pipelineQueryPlan);
            }
        });
    });
</script>
{% endblock %}